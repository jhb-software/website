---
import { normalizePath } from '@/utils/normalizePath'
import { SITE_URL } from 'astro:env/client'
import type { Breadcrumbs } from 'cms/src/payload-types'

type Props = {
  crumbs: Breadcrumbs
  displayMode?: 'full' | 'lastOnly'
}

const { crumbs, displayMode = 'lastOnly' } = Astro.props
const isPreview = Astro.url.pathname.startsWith('/preview')

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: crumbs.map((part, index) => ({
    '@type': 'ListItem',
    item: SITE_URL + part.path,
    name: part.label,
    position: index + 1,
  })),
}

const structuredDataScript = JSON.stringify(structuredData, null, 2)
---

{
  displayMode === 'full' && (
    <nav aria-label="breadcrumbs">
      <ol class:list={['flex flex-row justify-center gap-2 text-sm text-slate-500']}>
        {crumbs
          .map(({ label, path }, index, array) => (
            <li>
              <a
                href={normalizePath(path, isPreview)}
                aria-current={index + 1 === array.length ? 'location' : false}
              >
                {label.toUpperCase()}
              </a>
            </li>
          ))
          .reduce((prev, curr) => [
            prev,
            <span aria-hidden class="text-secondary">
              /
            </span>,
            curr,
          ])}
      </ol>
    </nav>
  )
}

{
  displayMode === 'lastOnly' && (
    <nav aria-label="breadcrumbs">
      <ol class:list={['flex flex-row justify-center gap-2 text-sm text-slate-500']}>
        {crumbs.length > 1 && (
          <li>
            <a
              href={normalizePath(crumbs[crumbs.length - 2].path, isPreview)}
              class="flex items-center gap-1"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M15 18l-6-6 6-6" />
              </svg>
              {crumbs[crumbs.length - 2].label.toUpperCase()}
            </a>
          </li>
        )}
      </ol>
    </nav>
  )
}
{(<script type="application/ld+json" set:html={structuredDataScript} />)}
