---
// Refreshes the page for live preview when a document is saved in the CMS.
// see https://payloadcms.com/docs/live-preview/server
//
// This script is similar to https://github.com/payloadcms/payload/blob/main/packages/live-preview-react/src/RefreshRouteOnSave.tsx but for Astro.
---

<script>
  import { isDocumentEvent, ready } from '@payloadcms/live-preview'
  import { CMS_URL } from 'astro:env/client'

  function sendReady() {
    ready({ serverURL: CMS_URL })
  }

  function onMessage(event: MessageEvent) {
    if (isDocumentEvent(event, CMS_URL)) {
      window.location.reload()
    }
  }

  window.addEventListener('message', onMessage)

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', sendReady, { once: true })
  } else {
    sendReady()
  }
</script>
