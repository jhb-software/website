---
import { payloadSDK } from '@/cms/sdk'
import Icon from '@/components/icons/Icon.astro'
import type { TestimonialsBlock } from 'cms/src/payload-types'
import TestimonialCard from '../cards/TestimonialCard.astro'

export type Props = TestimonialsBlock

const { testimonials } = Astro.props
const { labels, locale, preview } = Astro.locals.globalState

// Fetch the testimonials with depth 2 to ensure all related fields are populated
const populatedTestimonials = await payloadSDK.find(
  {
    collection: 'testimonials',
    locale: locale,
    draft: false,
    pagination: false,
    depth: 2,
    where: {
      id: {
        in: testimonials.map((testimonial) =>
          typeof testimonial === 'string' ? testimonial : testimonial.id,
        ),
      },
    },
  },
  {
    headers: {
      'X-Use-Cache': preview ? 'false' : 'true',
    },
  },
)
---

<div class="group relative" id="testimonials-container" data-expanded={false}>
  <div
    class:list={[
      'space-y-5',
      ...(populatedTestimonials.docs?.length > 1
        ? [
            'group-data-[expanded=false]:mask-b-from-60%',
            'group-data-[expanded=false]:h-[33rem]',
            'overflow-y-hidden',
          ]
        : []),
      'relative',
    ]}
  >
    <div
      class:list={[
        'gap-5 space-y-5',
        populatedTestimonials.docs?.length > 1
          ? 'columns-1 sm:columns-2 lg:columns-3'
          : 'mx-auto max-w-2xl columns-1',
      ]}
    >
      {
        populatedTestimonials.docs?.map((testimonial) => (
          <div class="inline-block w-full break-inside-avoid">
            <TestimonialCard {...testimonial} />
          </div>
        ))
      }
    </div>
  </div>

  {
    populatedTestimonials.docs?.length > 1 && (
      <div
        class:list={[
          'pointer-events-none absolute inset-x-0 bottom-0 justify-center',
          'flex group-data-[expanded=true]:hidden',
          'pt-32 pb-8',
        ]}
      >
        <button class="bg-primary pointer-events-auto relative flex translate-y-4 cursor-pointer items-center gap-3 rounded-md px-4 py-3 text-sm font-semibold text-white no-underline">
          {labels.global['show-more']}
          <Icon name="chevron-down" class:list={['h-3 w-3']} />
        </button>
      </div>
    )
  }
</div>

<script>
  function setupTestimonials() {
    const container = document.querySelector('#testimonials-container')
    const button = container?.querySelector('button')

    if (container && button) {
      button.addEventListener('click', () => {
        const isExpanded = container.getAttribute('data-expanded') === 'true'
        container.setAttribute('data-expanded', (!isExpanded).toString())
      })
    }
  }

  // Run setup function on the initial and any subsequent page loads due to navigation
  // https://docs.astro.build/en/guides/view-transitions/#astropage-load
  document.addEventListener('astro:page-load', setupTestimonials)
</script>
