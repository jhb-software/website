---
import RichTextLexical from '@jhb.software/astro-payload-richtext-lexical/RichTextLexical.astro'
import type { ResolveInternalLink } from '@jhb.software/astro-payload-richtext-lexical'
import type { RichTextBlock as RichTextBlockType } from 'cms/src/payload-types'
import { normalizePath } from '../../../utils/normalizePath'
import BlockRenderer from './BlockRenderer.astro'
import UploadRenderer from './UploadRenderer.astro'

type Props = Omit<RichTextBlockType, 'blockType'> & {
  class?: string
}

const { text, class: className } = Astro.props
const { preview } = Astro.locals.globalState

const resolveInternalLink: ResolveInternalLink = (doc) => {
  if ('path' in doc && typeof doc.path === 'string') {
    return normalizePath(doc.path, preview)
  }
  return undefined
}
---

<RichTextLexical
  nodes={text.root.children}
  UploadRenderer={UploadRenderer}
  BlockRenderer={BlockRenderer}
  resolveInternalLink={resolveInternalLink}
  class:list={['prose mx-auto !max-w-none', className]}
/>
