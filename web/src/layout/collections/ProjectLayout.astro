---
import RichTextBlock from '@/components/blocks/RichTextBlock/RichTextBlock.astro'
import BreadcrumbsBlock from '@/components/Breadcrumbs.astro'
import TestimonialCard from '@/components/cards/TestimonialCard.astro'
import Img from '@/components/Img.astro'
import ProjectDate from '@/components/ProjectDate.astro'
import ProjectTagsList from '@/components/ProjectTagsList.astro'
import { globalState } from '@/globalState'
import SectionShell from '@/layout/SectionShell.astro'
import { projectSchema } from '@/schema/project'
import { Schema } from 'astro-seo-schema'
import type { Breadcrumbs, Media, Project, Testimonial } from 'cms/src/payload-types'

type Props = {
  project: Project
  breadcrumbs: Breadcrumbs
}

const { project: pageData, breadcrumbs } = Astro.props
const { labels } = globalState

const schema = projectSchema(pageData)

// Extract testimonials from the join field
const testimonials = pageData.testimonials?.docs?.filter((testimonial): testimonial is Testimonial => 
  typeof testimonial === 'object'
) || []
---

<SectionShell>
  {breadcrumbs && <BreadcrumbsBlock crumbs={breadcrumbs} />}
  <h1 class="mt-4 text-center text-4xl font-extrabold text-balance text-slate-700">
    {pageData.title}
  </h1>

  <div class="flex flex-col items-center gap-4">
    <ProjectDate
      startDate={pageData.startDate}
      endDate={pageData.endDate}
      class="mt-4 text-center"
    />

    <ProjectTagsList tags={pageData.tags} />
  </div>

  <Img
    image={pageData.image as Media}
    size="xl"
    class="mx-auto my-8 w-full max-w-4xl rounded-xl"
    fetchpriority="high"
  />

  <RichTextBlock text={pageData.body} />

  {testimonials.length > 0 && (
    <section class="mt-16">
      <h2 class="mb-8 text-center text-3xl font-bold text-slate-700">
        {labels.testimonials?.['testimonials-title'] || 'Testimonials'}
      </h2>
      <div class="columns-1 gap-5 space-y-5 sm:columns-2 lg:columns-3">
        {testimonials.map((testimonial) => (
          <div class="inline-block w-full break-inside-avoid">
            <TestimonialCard {...testimonial} />
          </div>
        ))}
      </div>
    </section>
  )}
</SectionShell>

<Schema item={schema} />
