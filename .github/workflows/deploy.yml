# Deployment workflow for the JHB Software website.
#
# This workflow deploys the CMS before the Web frontend to ensure the frontend
# always builds against the latest CMS schema and content. The Web frontend
# fetches data from the CMS at build time, so the CMS must be deployed first.
#
# Production: Triggered on push to main
# Preview: Triggered on pull requests, uses CMS preview URL for Web build
#
# Prerequisites:
# - Disable automatic Vercel deployments for both projects to avoid race conditions
# - Disable Vercel Authentication for CMS preview deployments (Settings â†’ Deployment Protection)
#
# TODO: Migrate to using VERCEL_AUTOMATION_BYPASS_SECRET instead of disabling authentication.
# This would require passing the bypass header in getRedirects.ts and the PayloadSDK.

name: Deploy

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      deploy_cms:
        description: 'Deploy CMS'
        required: false
        default: true
        type: boolean
      deploy_web:
        description: 'Deploy Web'
        required: false
        default: true
        type: boolean
      environment:
        description: 'Environment'
        required: false
        default: 'preview'
        type: choice
        options:
          - preview
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  deploy-cms:
    name: Deploy CMS
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_cms == 'true' }}
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
      inspect_url: ${{ steps.deploy.outputs.inspect_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        run: |
          PROD_FLAG=${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event.inputs.environment == 'production' && '--prod' || '' }}
          OUTPUT=$(npx vercel deploy $PROD_FLAG --yes --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          echo "$OUTPUT"
          echo "deployment_url=$(echo "$OUTPUT" | grep -E '^https://' | tail -1)" >> $GITHUB_OUTPUT
          echo "inspect_url=$(echo "$OUTPUT" | grep 'Inspect:' | awk '{print $2}')" >> $GITHUB_OUTPUT
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_CMS_PROJECT_ID }}

  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: deploy-cms
    if: ${{ always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_web == 'true') && (needs.deploy-cms.result == 'success' || needs.deploy-cms.result == 'skipped') }}
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
      inspect_url: ${{ steps.deploy.outputs.inspect_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        run: |
          IS_PROD=${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event.inputs.environment == 'production' }}
          if [ "$IS_PROD" == "true" ]; then
            OUTPUT=$(npx vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          else
            OUTPUT=$(npx vercel deploy --yes --token=${{ secrets.VERCEL_TOKEN }} \
              --build-env CMS_URL=${{ needs.deploy-cms.outputs.deployment_url }} \
              --env CMS_URL=${{ needs.deploy-cms.outputs.deployment_url }} 2>&1)
          fi
          echo "$OUTPUT"
          echo "deployment_url=$(echo "$OUTPUT" | grep -E '^https://' | tail -1)" >> $GITHUB_OUTPUT
          echo "inspect_url=$(echo "$OUTPUT" | grep 'Inspect:' | awk '{print $2}')" >> $GITHUB_OUTPUT
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_WEB_PROJECT_ID }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Project | URL | Inspect |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| CMS | ${{ needs.deploy-cms.outputs.deployment_url }} | [View](${{ needs.deploy-cms.outputs.inspect_url }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ steps.deploy.outputs.deployment_url }} | [View](${{ steps.deploy.outputs.inspect_url }}) |" >> $GITHUB_STEP_SUMMARY

  comment-preview:
    name: Comment Preview URLs
    runs-on: ubuntu-latest
    needs: [deploy-cms, deploy-web]
    if: ${{ github.event_name == 'pull_request' && needs.deploy-web.result == 'success' }}
    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Preview Deployment'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## Preview Deployment

            | Project | Preview | Inspect |
            |---------|---------|---------|
            | CMS | ${{ needs.deploy-cms.outputs.deployment_url }} | [View](${{ needs.deploy-cms.outputs.inspect_url }}) |
            | Web | ${{ needs.deploy-web.outputs.deployment_url }} | [View](${{ needs.deploy-web.outputs.inspect_url }}) |

            The Web preview uses the CMS preview URL for content fetching.
